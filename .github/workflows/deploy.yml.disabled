name: Deploy Python FastAPI (Oryx build on Azure)

on:
  push:
    branches:
      - multiagent-v2

# Prevent overlapping deploys to the same branch (avoids OneDeploy conflicts / 409).
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Optional: add lint/type-check steps here if you like.

      # Create a reproducible ZIP package explicitly to avoid EISDIR in webapps-deploy.
      # Exclude .git and the workflows folder to keep the artifact clean.
      - name: Create deployment ZIP
        run: |
          zip -r deploy.zip . \
            -x ".git/*" \
            -x ".github/workflows/*"

      # Deploy the ZIP package. Using a concrete file path avoids EISDIR.
      - name: Deploy to Azure Web App (OneDeploy + Oryx build)
        uses: azure/webapps-deploy@v3
        with:
          app-name: multiagentcrew
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy.zip
          type: zip          # keep zip to trigger Oryx server-side Python build
          clean: true
          restart: true
