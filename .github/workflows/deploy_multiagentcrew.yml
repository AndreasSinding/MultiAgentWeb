name: Build and deploy (Oryx from source) - multiagentcrew

on:
  push:
    branches: [ multiagentppt ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: multiagentcrew-prod-deploy
  cancel-in-progress: true

env:
  AZURE_WEBAPP_NAME: multiagentcrew
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python (for sanity checks only)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Ensure runtime.txt (forces Python detection)
        run: |
          if [ ! -f runtime.txt ]; then
            echo "python-${{ env.PYTHON_VERSION }}" > runtime.txt
          fi
          cat runtime.txt

      - name: Verify requirements.txt exists at repo root
        run: |
          test -f requirements.txt || (echo "requirements.txt missing at repo root" && exit 1)
          head -n 50 requirements.txt || true

      - name: Dependency sanity check (runner only)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        # This is just a fast fail check; App Service will install again during Oryx.

      # ---- NEW: auto-fix common HTML-entity artifacts before compiling ----
      - name: Auto-fix HTML entities/backticks under ui/
        shell: bash
        run: |
          set -euo pipefail
          find ui -type f -name "*.py" -print0 | xargs -0 sed -i \
            -e 's/-&gt;/->/g' \
            -e 's/&gt;=/>=/g' \
            -e 's/&gt;/>/g' \
            -e 's/&lt;=/<=/g' \
            -e 's/&lt;/</g' \
            -e 's/&amp;/\&/g' \
            -e 's/`//g'
          # Show any remaining offenders (non-fatal)
          if grep -RInE --exclude-dir='\.git' --exclude-dir='__pycache__' '(-&gt;|&gt;=|&lt;|&amp;|`)' ui | head -n 1; then
            echo "WARNING: Some HTML entities/backticks may remain; attempting to continue..."
          else
            echo "No HTML entities/backticks found after auto-fix."
          fi

      - name: Quick static checks (compile)
        run: |
          python -m compileall -q .
        # If something is still invalid Python, this will fail fast.

      - name: Azure login (publish profile)
        uses: azure/login@v2
        with:
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}

      - name: Ensure 'SCM_DO_BUILD_DURING_DEPLOYMENT' app setting (Oryx build)
        shell: bash
        run: |
          set -euo pipefail
          RG=$(az resource show --resource-type Microsoft.Web/sites -n "${{ env.AZURE_WEBAPP_NAME }}" --query resourceGroup -o tsv)
          echo "Resolved resource group: $RG"
          az webapp config appsettings set -g "$RG" -n "${{ env.AZURE_WEBAPP_NAME }}" \
            --settings SCM_DO_BUILD_DURING_DEPLOYMENT=true
          echo "Confirmed SCM_DO_BUILD_DURING_DEPLOYMENT=true"

      - name: Deploy to Azure Web App (source folder â†’ Oryx build)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: .                         # deploy source; triggers Oryx build
          clean: true
          restart: true
          startup-command: >
            gunicorn main:app
            -k uvicorn.workers.UvicornWorker
            --bind=0.0.0.0:$PORT
            --timeout 600
            --workers 1
          






