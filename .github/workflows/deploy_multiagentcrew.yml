#New deploy_multiagentcrew 
# Remember to WEBSITE_RUN_FROM_PACKAGE = 1 

name: Deploy FastAPI to Azure Web App (Run from Package)

on:
  push:
    branches: [ multiagentsearch ]   # or your chosen branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # Optional: build step only to validate deps locally; Azure will just run the package
    - name: Validate dependencies
      run: |
        pip install -r requirements.txt
        python -c "print('deps ok')"

    - name: Sanity checks (block regressions)
      run: |
        # 1) Ensure the Exa tool no longer references crewai_tools
        if grep -R "from crewai_tools import BaseTool" app/exa_tool.py; then
          echo "ERROR: 'crewai_tools' import found in app/exa_tool.py"
          exit 1
        fi
        # 2) Ensure our local BaseTool exists
        test -f app/base_tool.py || (echo "ERROR: app/base_tool.py missing" && exit 1)

    - name: Create deployment package (zip CONTENTS, not the folder)
      run: |
        rm -f release.zip
        # zip from repo root but exclude junk and caches
        zip -r release.zip . \
          -x "*.git*" \
          -x "*__pycache__*" \
          -x "*.pytest_cache*" \
          -x ".venv/*" \
          -x "antenv/*" \
          -x "dist/*" \
          -x "build/*"

        echo "ZIP created:"
        unzip -l release.zip | sed -n '1,40p'

    - name: Deploy to Azure Web App (Run-From-Package)
      uses: azure/webapps-deploy@v3
      with:
        app-name: multiagentcrew            # <-- your app
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }} # export from Azure Portal
        package: release.zip

    # Optional: force restart so a new /tmp/<id> is used immediately
    #- name: Restart Web App
    #  uses: azure/cli@v2
    #  with:
    #    inlineScript: |
    #      az webapp restart \
    #        --resource-group "<YOUR_RESOURCE_GROUP>" \
    #        --name "multiagentcrew-ebazexd2e0h7e4fh"
    #  env:
    #    AZURE_CLIENT_ID:     ${{ secrets.AZURE_CLIENT_ID }}
    #    AZURE_TENANT_ID:     ${{ secrets.AZURE_TENANT_ID }}
    #    AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

    #Smoke test with cackoff
    - name: Smoke test /status (retry for warmup)
      shell: bash
      env:
        SITE_URL: https://<your-app-name>.azurewebsites.net
      run: |
        echo "Waiting for app warmup..."
        max_attempts=20
        delay=10
        for i in $(seq 1 $max_attempts); do
          code=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL/status")
          if [[ "$code" == "200" ]]; then
            echo "Status check succeeded (HTTP 200)."
            exit 0
          fi
          echo "Attempt $i/$max_attempts: got HTTP $code; retrying in ${delay}s..."
          sleep $delay
          # optional backoff
          if [[ $delay -lt 30 ]]; then delay=$((delay+2)); fi
        done
        echo "Status check failed after $max_attempts attempts."
        exit 1

