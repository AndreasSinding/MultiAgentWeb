#New deploy_multiagentcrew 
# Remember to WEBSITE_RUN_FROM_PACKAGE = 1 

name: Deploy FastAPI to Azure Web App (Run from Package)

on:
  push:
    branches: [ main ]   # or your chosen branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # Optional: build step only to validate deps locally; Azure will just run the package
    - name: Validate dependencies
      run: |
        pip install -r requirements.txt
        python -c "print('deps ok')"

    - name: Sanity checks (block regressions)
      run: |
        # 1) Ensure the Exa tool no longer references crewai_tools
        if grep -R "from crewai_tools import BaseTool" app/exa_tool.py; then
          echo "ERROR: 'crewai_tools' import found in app/exa_tool.py"
          exit 1
        fi
        # 2) Ensure our local BaseTool exists
        test -f app/base_tool.py || (echo "ERROR: app/base_tool.py missing" && exit 1)

    - name: Create deployment package (zip CONTENTS, not the folder)
      run: |
        rm -f release.zip
        # zip from repo root but exclude junk and caches
        zip -r release.zip . \
          -x "*.git*" \
          -x "*__pycache__*" \
          -x "*.pytest_cache*" \
          -x ".venv/*" \
          -x "antenv/*" \
          -x "dist/*" \
          -x "build/*"

        echo "ZIP created:"
        unzip -l release.zip | sed -n '1,40p'

    - name: Deploy to Azure Web App (Run-From-Package)
      uses: azure/webapps-deploy@v3
      with:
        app-name: multiagentcrew-ebazexd2e0h7e4fh             # <-- your app
        publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }} # export from Azure Portal
        package: release.zip

    # Optional: force restart so a new /tmp/<id> is used immediately
    - name: Restart Web App
      uses: azure/cli@v2
      with:
        inlineScript: |
          az webapp restart \
            --resource-group "<YOUR_RESOURCE_GROUP>" \
            --name "multiagentcrew-ebazexd2e0h7e4fh"
      env:
        AZURE_CLIENT_ID:     ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_TENANT_ID:     ${{ secrets.AZURE_TENANT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

    # Optional: smoke test
    - name: Smoke test /status
      run: |
        # Wait a few seconds for warmup
        sleep 10
        curl -fsS https://multiagentcrew-ebazexd2e0h7e4fh.westeurope-01.azurewebsites.net/status || (echo "Status check failed" && exit 1)
