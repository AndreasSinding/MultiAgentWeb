#New deploy_multiagentcrew 
# Remember to WEBSITE_RUN_FROM_PACKAGE = 1 
name: Deploy FastAPI to Azure Web App (Python + Oryx)

on:
  push:
    branches: [ multiagentsearch ]

env:
  APP_NAME: multiagentcrew
  HEALTH_PATH: /status

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # --- Show structure for debugging
    - name: Show repo structure (first 200 entries)
      run: |
        echo "Repository root:"
        find . -maxdepth 3 -type f -printf "%p\n" | sort | sed -n '1,200p'

    # --- Zip entire repo root (without .git etc.)
    - name: Create deployment package (ZipDeploy + Oryx)
      run: |
        rm -f release.zip
        zip -r release.zip . \
          -x "*.git*" \
          -x "**/__pycache__/**" \
          -x "*.pytest_cache*" \
          -x ".github/**" \
          -x ".venv/**" \
          -x "dist/**" \
          -x "build/**"

        echo "ZIP created (first 40 entries):"
        unzip -l release.zip | sed -n '1,40p'

    - name: Deploy to Azure Web App
      id: deploy
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: release.zip

    # --- Smoke test (retry)
    - name: Smoke Test
      shell: bash
      env:
        SITE_URL: ${{ steps.deploy.outputs.webapp-url }}
        HEALTH_PATH: ${{ env.HEALTH_PATH }}
      run: |
        set +e
        if [ -z "$SITE_URL" ]; then
          echo "ERROR: deploy produced no webapp-url"
          exit 2
        fi

        URL="${SITE_URL}${HEALTH_PATH}"
        echo "Probing $URL"

        max_attempts=30
        delay=10

        for i in $(seq 1 $max_attempts); do
          echo "Attempt $i..."
          HTTP_CODE=$(curl -k -L -sS -o /tmp/body.txt -w "%{http_code}" "$URL")
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "App healthy ✔"
            exit 0
          fi
          sleep $delay
        done

        echo "❌ App did not become ready"
        head -c 500 /tmp/body.txt || true
        exit 1
