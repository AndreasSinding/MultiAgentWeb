#New deploy_multiagentcrew 
# Remember to WEBSITE_RUN_FROM_PACKAGE = 1 

name: Deploy FastAPI to Azure Web App (Run-From-Package)

on:
  push:
    branches: [ multiagentsearch ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # -------------------------------------------------------
    # CHECKOUT
    # -------------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # -------------------------------------------------------
    # PYTHON TOOLING
    # -------------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Validate dependencies
      run: |
        pip install -r requirements.txt
        python -c "print('Dependencies OK')"

    # -------------------------------------------------------
    # SANITY CHECKS
    # -------------------------------------------------------
    - name: Sanity checks (block regressions)
      run: |
        if grep -R "from crewai_tools import BaseTool" app/exa_tool.py; then
          echo "ERROR: crewai_tools import detected in exa_tool.py"
          exit 1
        fi
        if [ ! -f app/base_tool.py ]; then
          echo "ERROR: base_tool.py missing"
          exit 1
        fi

    # -------------------------------------------------------
    # PACKAGE APP (ZIP CONTENTS ONLY)
    # -------------------------------------------------------
    - name: Create deployment package
      run: |
        rm -f release.zip
        zip -r release.zip . \
            -x "*.git*" \
            -x "**/__pycache__/**" \
            -x "*.pytest_cache*" \
            -x ".venv/**" \
            -x "antenv/**" \
            -x "dist/**" \
            -x "build/**"

        echo "ZIP created:"
        unzip -l release.zip | sed -n '1,40p'

    # -------------------------------------------------------
    # DEPLOY TO AZURE (APP NAME = multiagentcrew)
    # -------------------------------------------------------
    - name: Deploy to Azure Web App (Run-From-Package)
      id: deploy
      uses: azure/webapps-deploy@v3
      with:
        app-name: multiagentcrew
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: release.zip

    # -------------------------------------------------------
    # SMOKE TEST USING THE REAL DEPLOYMENT URL
    # -------------------------------------------------------
    - name: Smoke Test /status (retry for warmup)
      shell: bash
      env:
        HEALTH_PATH: /status
      run: |
        set +e

        SITE_URL="${{ steps.deploy.outputs.webapp-url }}"
        if [ -z "$SITE_URL" ]; then
          echo "ERROR: deploy step produced no webapp-url output"
          exit 2
        fi

        URL="${SITE_URL}${HEALTH_PATH}"
        echo "Smoke-testing: $URL"

        HOSTNAME=$(echo "$SITE_URL" | sed -E 's#https?://([^/]+)/?.*#\1#')
        echo "Resolved hostname: $HOSTNAME"
        getent hosts "$HOSTNAME" || echo "DNS lookup failed (non-fatal)"

        max_attempts=30
        delay=10

        for i in $(seq 1 $max_attempts); do
          echo "Attempt $i/$max_attempts..."
          HTTP_CODE=$(curl -k -L -sS -o /tmp/body.txt -w "%{http_code}" "$URL")
          EXIT=$?

          if [[ $EXIT -ne 0 ]]; then
            echo "curl exited with $EXIT; retrying in ${delay}s..."
          else
            echo "HTTP $HTTP_CODE"
            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "Application is healthy ✔"
              exit 0
            fi
          fi

          sleep $delay
          if [[ $delay -lt 40 ]]; then delay=$((delay+2)); fi
        done

        echo "❌ Smoke test failed"
        echo "Last response body (first 500 chars):"
        head -c 500 /tmp/body.txt || true
        exit 1
