name: Deploy FastAPI to Azure Web App (Publish Profile, GitHub Actions)

on:
  push: 
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Optional: run quick sanity checks or tests before deploy
      - name: Set up Python for checks
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Verify requirements file exists
        run: |
          test -f requirements.txt || (echo "requirements.txt missing at repo root" && exit 1)
          python -m pip install --upgrade pip
          # Optional: lightweight import check (won't affect Azure build)
          pip install -r requirements.txt || true

      # Deploy the repository to Azure Web App using Publish Profile
      # Oryx will be triggered server-side to build Python dependencies into 'antenv'
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: multiagentcrew
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: .
          clean: true         # remove leftovers from previous deploys
          restart: true       # restart app after deployment

      # (Optional once-off) ensure we are NOT using run-from-package for Python
      # You can remove this step later; itâ€™s safe to run even if the setting isn't present.
      - name: Remove WEBSITE_RUN_FROM_PACKAGE if present
        shell: bash
        run: |
          echo "Skipping removal here because Publish Profile auth doesn't grant az CLI by default."
          echo "If needed, remove WEBSITE_RUN_FROM_PACKAGE in Azure Portal: Configuration -> Application settings."
